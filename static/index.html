<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿¼é¾™é¢æ¿ç›‘æ§ - åœæœºä¿æ´»</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 {
            text-align: center;
            padding: 30px 0;
            font-size: 2em;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-desc {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card-title {
            font-size: 1.2em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.9em;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 14px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #7c3aed;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(90deg, #7c3aed, #00d4ff);
            color: #fff;
        }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-success { background: #22c55e; color: #fff; }
        .btn-warning { background: #f59e0b; color: #fff; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .server-list { display: grid; gap: 15px; }
        .server-item {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .server-name { font-size: 1.1em; font-weight: 600; }
        .server-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #aaa;
        }
        .server-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-running { background: #22c55e33; color: #22c55e; }
        .status-offline { background: #ef444433; color: #ef4444; }
        .status-starting { background: #f59e0b33; color: #f59e0b; }
        .status-stopping { background: #f59e0b33; color: #f59e0b; }
        .status-unknown { background: #64748b33; color: #64748b; }
        .status-error { background: #ef444433; color: #ef4444; }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #374151;
            transition: .3s;
            border-radius: 26px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider { background-color: #7c3aed; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
        }
        .log-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
            font-family: monospace;
        }
        .log-time { color: #64748b; }
        .log-action { color: #00d4ff; }
        .log-success { color: #22c55e; }
        .log-failed { color: #ef4444; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 1.3em;
            margin-bottom: 20px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        .header-bar {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-bar h1 {
            margin: 0;
            padding: 20px 0 5px 0;
        }
        .header-bar .header-desc {
            margin: 0;
        }
        .header-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-logout {
            background: #64748b;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-value { font-size: 1.5em; font-weight: bold; }
        .stat-label { font-size: 0.8em; color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <div></div>
            <div>
                <h1>ğŸ‰ ç¿¼é¾™é¢æ¿ç›‘æ§</h1>
                <p class="header-desc">Pterodactyl Server Monitor - åœæœºè‡ªåŠ¨ä¿æ´»</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-sm" onclick="showSettings()">âš™ï¸ è®¾ç½®</button>
                <button class="btn btn-sm btn-logout" id="logout-btn" style="display:none;" onclick="logout()">ğŸšª ç™»å‡º</button>
            </div>
        </div>

        <div class="stats" id="stats">
            <div class="stat-item">
                <div class="stat-value" id="total-servers">0</div>
                <div class="stat-label">ç›‘æ§æœåŠ¡å™¨</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="online-servers">0</div>
                <div class="stat-label">åœ¨çº¿</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="offline-servers">0</div>
                <div class="stat-label">ç¦»çº¿</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-restarts">0</div>
                <div class="stat-label">è‡ªåŠ¨é‡å¯æ¬¡æ•°</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">â• æ·»åŠ ç›‘æ§æœåŠ¡å™¨</div>
            <form id="add-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>æœåŠ¡å™¨åç§°</label>
                        <input type="text" id="name" placeholder="æˆ‘çš„æœåŠ¡å™¨" required>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>APIåœ°å€ï¼ˆåŒ…å«æœåŠ¡å™¨IDï¼‰</label>
                        <input type="text" id="api_url" placeholder="https://panel.example.com/api/client/servers/a1b2c3d4" required>
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="text" id="api_key" placeholder="ptlc_xxxxxx" required>
                    </div>
                    <div class="form-group">
                        <label>ç›‘æ§é—´éš”ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="interval" value="10" min="5">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>ä»£ç†åœ°å€ï¼ˆå¯é€‰ï¼Œç»•è¿‡CFé˜²æŠ¤ï¼‰</label>
                        <input type="text" id="proxy_url" placeholder="socks5://127.0.0.1:1080 æˆ– http://127.0.0.1:8080">
                    </div>
                </div>
                <p style="color:#888;font-size:12px;margin:10px 0;">ğŸ’¡ æç¤ºï¼šå¦‚æœé‡åˆ° Cloudflare é˜²æŠ¤ï¼Œå¯é…ç½® SOCKS5/HTTP ä»£ç†ç»•è¿‡</p>
                <button type="submit" class="btn btn-primary">æ·»åŠ æœåŠ¡å™¨</button>
            </form>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“¡ ç›‘æ§åˆ—è¡¨</div>
            <div class="server-list" id="server-list">
                <div class="empty-state">æš‚æ— ç›‘æ§æœåŠ¡å™¨ï¼Œè¯·æ·»åŠ </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“‹ æœ€è¿‘æ—¥å¿—</div>
            <div class="logs-container" id="logs-container">
                <div class="empty-state">æš‚æ— æ—¥å¿—</div>
            </div>
        </div>
    </div>

    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-title">âœï¸ ç¼–è¾‘æœåŠ¡å™¨</div>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>æœåŠ¡å™¨åç§°</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="form-group">
                    <label>APIåœ°å€ï¼ˆåŒ…å«æœåŠ¡å™¨IDï¼‰</label>
                    <input type="text" id="edit-api_url" required>
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="text" id="edit-api_key" required>
                </div>
                <div class="form-group">
                    <label>ç›‘æ§é—´éš”ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="edit-interval" min="5">
                </div>
                <div class="form-group">
                    <label>ä»£ç†åœ°å€ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="edit-proxy_url" placeholder="socks5://127.0.0.1:1080">
                </div>
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn" onclick="closeEditModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="logs-modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“‹ æœåŠ¡å™¨æ—¥å¿—</div>
            <div class="logs-container" id="server-logs"></div>
            <button class="btn" style="margin-top:15px;" onclick="closeLogsModal()">å…³é—­</button>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">âš™ï¸ è®¾ç½®</div>
            
            <div class="settings-section">
                <h4 style="margin-bottom:15px;color:#00d4ff;">ğŸ” è®¿é—®è®¤è¯</h4>
                <p style="color:#888;font-size:13px;margin-bottom:15px;">è®¾ç½®è´¦å·å¯†ç åè‡ªåŠ¨å¯ç”¨è®¤è¯ï¼Œæ¸…ç©ºåˆ™ç¦ç”¨è®¤è¯</p>
                
                <div class="auth-status" id="auth-status" style="margin-bottom:15px;padding:10px;border-radius:8px;font-size:13px;"></div>
                
                <form id="auth-form">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="auth-username" placeholder="è®¾ç½®ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="auth-password" placeholder="è®¾ç½®å¯†ç ">
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                        <button type="button" class="btn btn-danger" onclick="disableAuth()">ç¦ç”¨è®¤è¯</button>
                    </div>
                </form>
            </div>
            
            <div class="settings-section" style="margin-top:20px;border-top:1px solid #333;padding-top:20px;">
                <h4 style="margin-bottom:15px;color:#00d4ff;">ğŸ“¦ æ•°æ®å¤‡ä»½</h4>
                <p style="color:#888;font-size:13px;margin-bottom:15px;">å¯¼å‡º/å¯¼å…¥æœåŠ¡å™¨é…ç½®ï¼Œæ–¹ä¾¿è¿ç§»æˆ–å¤‡ä»½</p>
                
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button type="button" class="btn btn-primary" onclick="exportBackup()">ğŸ“¤ å¯¼å‡ºå¤‡ä»½</button>
                    <button type="button" class="btn btn-success" onclick="document.getElementById('import-file').click()">ğŸ“¥ å¯¼å…¥å¤‡ä»½</button>
                    <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importBackup(this)">
                </div>
                <p id="backup-status" style="color:#888;font-size:12px;margin-top:10px;"></p>
            </div>
            
            <button class="btn" style="margin-top:20px;" onclick="closeSettingsModal()">å…³é—­</button>
        </div>
    </div>

    <script>
        let servers = [];
        let refreshInterval;

        async function fetchServers() {
            try {
                const res = await fetch('/api/servers');
                const data = await res.json();
                if (data.success) {
                    servers = data.servers;
                    renderServers();
                    updateStats();
                }
            } catch (e) {
                console.error('Failed to fetch servers:', e);
            }
        }

        async function fetchLogs() {
            try {
                const res = await fetch('/api/logs?limit=50');
                const data = await res.json();
                if (data.success) {
                    renderLogs(data.logs);
                }
            } catch (e) {
                console.error('Failed to fetch logs:', e);
            }
        }

        function renderServers() {
            const container = document.getElementById('server-list');
            if (servers.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— ç›‘æ§æœåŠ¡å™¨ï¼Œè¯·æ·»åŠ </div>';
                return;
            }

            container.innerHTML = servers.map(s => `
                <div class="server-item" data-id="${s.id}">
                    <div class="server-header">
                        <div>
                            <span class="server-name">${escapeHtml(s.name)}</span>
                            <span class="status-badge status-${s.last_status}">${getStatusText(s.last_status)}</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" ${s.enabled ? 'checked' : ''} onchange="toggleServer(${s.id})">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="server-info">
                        <div style="grid-column: span 2; word-break: break-all;">ğŸ”— ${escapeHtml(getFullUrl(s))}</div>
                        <div>â±ï¸ ${s.interval}ç§’</div>
                        <div>ğŸ”„ é‡å¯${s.restart_count}æ¬¡</div>
                        <div>ğŸ“¡ ${s.last_check ? new Date(s.last_check).toLocaleString() : 'æœªæ£€æŸ¥'}</div>
                        ${s.proxy_url ? `<div style="grid-column: span 2;">ğŸŒ ä»£ç†: ${escapeHtml(s.proxy_url.substring(0, 50))}${s.proxy_url.length > 50 ? '...' : ''}</div>` : ''}
                    </div>
                    <div class="server-actions">
                        <button class="btn btn-success btn-sm" onclick="powerAction(${s.id}, 'start')">å¯åŠ¨</button>
                        <button class="btn btn-warning btn-sm" onclick="powerAction(${s.id}, 'restart')">é‡å¯</button>
                        <button class="btn btn-danger btn-sm" onclick="powerAction(${s.id}, 'stop')">åœæ­¢</button>
                        <button class="btn btn-sm" onclick="showLogs(${s.id})">æ—¥å¿—</button>
                        <button class="btn btn-sm" onclick="editServer(${s.id})">ç¼–è¾‘</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteServer(${s.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function formatLogMessage(message) {
            // æ£€æµ‹ Cloudflare é˜²æŠ¤
            if (message && (message.includes('Just a moment') || message.includes('Cloudflare') || message.includes('cf-') || (message.includes('403') && message.includes('DOCTYPE')))) {
                return 'âš ï¸ <span style="color:#f59e0b;">æ£€æµ‹åˆ° Cloudflare é˜²æŠ¤ï¼Œè¯·æ£€æŸ¥APIåœ°å€æˆ–è”ç³»é¢æ¿ç®¡ç†å‘˜</span>';
            }
            return escapeHtml(message);
        }

        function renderLogs(logs) {
            const container = document.getElementById('logs-container');
            if (logs.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— æ—¥å¿—</div>';
                return;
            }

            container.innerHTML = logs.map(l => `
                <div class="log-item">
                    <span class="log-time">${new Date(l.created_at).toLocaleString()}</span>
                    <span class="log-action">[${l.server_name || 'Unknown'}]</span>
                    <span class="log-action">${l.action}</span>
                    <span class="log-${l.status}">${l.status}</span>
                    <span>${formatLogMessage(l.message)}</span>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('total-servers').textContent = servers.length;
            document.getElementById('online-servers').textContent = servers.filter(s => s.last_status === 'running').length;
            document.getElementById('offline-servers').textContent = servers.filter(s => s.last_status === 'offline').length;
            document.getElementById('total-restarts').textContent = servers.reduce((sum, s) => sum + s.restart_count, 0);
        }

        function getStatusText(status) {
            const map = {
                'running': 'è¿è¡Œä¸­',
                'offline': 'ç¦»çº¿',
                'starting': 'å¯åŠ¨ä¸­',
                'stopping': 'åœæ­¢ä¸­',
                'unknown': 'æœªçŸ¥',
                'error': 'é”™è¯¯'
            };
            return map[status] || status;
        }

        function getFullUrl(server) {
            // å¦‚æœ server_id æœ‰æ•ˆä¸”ä¸æ˜¯ '-'ï¼Œæ‹¼æ¥å®Œæ•´ URL
            if (server.server_id && server.server_id !== '-') {
                const url = server.api_url.replace(/\/$/, '');
                if (!url.endsWith(server.server_id)) {
                    return url + '/' + server.server_id;
                }
            }
            return server.api_url;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function toggleServer(id) {
            try {
                await fetch(`/api/servers/${id}/toggle`, { method: 'POST' });
                fetchServers();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥: ' + e.message);
            }
        }

        async function powerAction(id, action) {
            try {
                const res = await fetch(`/api/servers/${id}/power`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`${action} å‘½ä»¤å·²å‘é€`);
                } else {
                    alert('å¤±è´¥: ' + data.error);
                }
                fetchServers();
                fetchLogs();
            } catch (e) {
                alert('æ“ä½œå¤±è´¥: ' + e.message);
            }
        }

        async function deleteServer(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤æœåŠ¡å™¨ç›‘æ§ï¼Ÿ')) return;
            try {
                await fetch(`/api/servers/${id}`, { method: 'DELETE' });
                fetchServers();
                fetchLogs();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        function editServer(id) {
            const server = servers.find(s => s.id === id);
            if (!server) return;

            document.getElementById('edit-id').value = server.id;
            document.getElementById('edit-name').value = server.name;
            document.getElementById('edit-api_url').value = getFullUrl(server);
            document.getElementById('edit-api_key').value = server.api_key;
            document.getElementById('edit-interval').value = server.interval;
            document.getElementById('edit-proxy_url').value = server.proxy_url || '';

            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        async function showLogs(id) {
            try {
                const res = await fetch(`/api/servers/${id}/logs?limit=50`);
                const data = await res.json();
                if (data.success) {
                    const container = document.getElementById('server-logs');
                    if (data.logs.length === 0) {
                        container.innerHTML = '<div class="empty-state">æš‚æ— æ—¥å¿—</div>';
                    } else {
                        container.innerHTML = data.logs.map(l => `
                            <div class="log-item">
                                <span class="log-time">${new Date(l.created_at).toLocaleString()}</span>
                                <span class="log-action">${l.action}</span>
                                <span class="log-${l.status}">${l.status}</span>
                                <span>${escapeHtml(l.message)}</span>
                            </div>
                        `).join('');
                    }
                    document.getElementById('logs-modal').classList.add('active');
                }
            } catch (e) {
                alert('è·å–æ—¥å¿—å¤±è´¥: ' + e.message);
            }
        }

        function closeLogsModal() {
            document.getElementById('logs-modal').classList.remove('active');
        }

        document.getElementById('add-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('name').value,
                api_url: document.getElementById('api_url').value,
                api_key: document.getElementById('api_key').value,
                server_id: '-',  // ä» URL è‡ªåŠ¨è§£æ
                interval: parseInt(document.getElementById('interval').value) || 10,
                proxy_url: document.getElementById('proxy_url').value.trim()
            };

            try {
                const res = await fetch('/api/servers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    e.target.reset();
                    document.getElementById('interval').value = 10;
                    fetchServers();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.error);
                }
            } catch (err) {
                alert('æ·»åŠ å¤±è´¥: ' + err.message);
            }
        });

        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                name: document.getElementById('edit-name').value,
                api_url: document.getElementById('edit-api_url').value,
                api_key: document.getElementById('edit-api_key').value,
                server_id: '-',
                interval: parseInt(document.getElementById('edit-interval').value) || 10,
                proxy_url: document.getElementById('edit-proxy_url').value.trim()
            };

            try {
                const res = await fetch(`/api/servers/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeEditModal();
                    fetchServers();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.error);
                }
            } catch (err) {
                alert('æ›´æ–°å¤±è´¥: ' + err.message);
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // è®¾ç½®ç›¸å…³
        async function checkAuthStatus() {
            try {
                const res = await fetch('/api/auth/status');
                const data = await res.json();
                if (data.auth_enabled) {
                    document.getElementById('logout-btn').style.display = 'inline-block';
                }
                return data;
            } catch (e) {
                console.error('Failed to check auth status:', e);
            }
        }

        function showSettings() {
            checkAuthStatus().then(data => {
                const statusEl = document.getElementById('auth-status');
                if (data && data.auth_enabled) {
                    statusEl.innerHTML = 'âœ… è®¤è¯å·²å¯ç”¨';
                    statusEl.style.background = 'rgba(34, 197, 94, 0.2)';
                    statusEl.style.color = '#22c55e';
                } else {
                    statusEl.innerHTML = 'âš ï¸ è®¤è¯æœªå¯ç”¨ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®';
                    statusEl.style.background = 'rgba(245, 158, 11, 0.2)';
                    statusEl.style.color = '#f59e0b';
                }
            });
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('auth-username').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            
            if (!username || !password) {
                alert('ç”¨æˆ·åå’Œå¯†ç éƒ½ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            try {
                const res = await fetch('/api/auth/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    alert('è®¤è¯è®¾ç½®æˆåŠŸï¼');
                    document.getElementById('auth-username').value = '';
                    document.getElementById('auth-password').value = '';
                    checkAuthStatus();
                    showSettings(); // åˆ·æ–°çŠ¶æ€
                } else {
                    alert('è®¾ç½®å¤±è´¥: ' + data.error);
                }
            } catch (err) {
                alert('è®¾ç½®å¤±è´¥: ' + err.message);
            }
        });

        async function disableAuth() {
            if (!confirm('ç¡®å®šç¦ç”¨è®¤è¯ï¼Ÿç¦ç”¨åä»»ä½•äººéƒ½å¯ä»¥è®¿é—®é¢æ¿')) return;
            
            try {
                const res = await fetch('/api/auth/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: '', password: '' })
                });
                const data = await res.json();
                if (data.success) {
                    alert('è®¤è¯å·²ç¦ç”¨');
                    document.getElementById('logout-btn').style.display = 'none';
                    showSettings(); // åˆ·æ–°çŠ¶æ€
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            } catch (err) {
                alert('æ“ä½œå¤±è´¥: ' + err.message);
            }
        }

        // å¯¼å‡ºå¤‡ä»½
        async function exportBackup() {
            try {
                document.getElementById('backup-status').textContent = 'æ­£åœ¨å¯¼å‡º...';
                const res = await fetch('/api/backup/export');
                if (!res.ok) throw new Error('Export failed');
                
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ptero-monitor-backup-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                document.getElementById('backup-status').textContent = 'âœ… å¯¼å‡ºæˆåŠŸ!';
                setTimeout(() => document.getElementById('backup-status').textContent = '', 3000);
            } catch (err) {
                document.getElementById('backup-status').textContent = 'âŒ å¯¼å‡ºå¤±è´¥: ' + err.message;
            }
        }

        // å¯¼å…¥å¤‡ä»½
        async function importBackup(input) {
            const file = input.files[0];
            if (!file) return;
            
            try {
                document.getElementById('backup-status').textContent = 'æ­£åœ¨å¯¼å…¥...';
                const text = await file.text();
                const data = JSON.parse(text);
                
                const res = await fetch('/api/backup/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                
                if (result.success) {
                    document.getElementById('backup-status').textContent = `âœ… ${result.message}`;
                    fetchServers(); // åˆ·æ–°åˆ—è¡¨
                    setTimeout(() => document.getElementById('backup-status').textContent = '', 5000);
                } else {
                    document.getElementById('backup-status').textContent = 'âŒ ' + result.error;
                }
            } catch (err) {
                document.getElementById('backup-status').textContent = 'âŒ å¯¼å…¥å¤±è´¥: ' + err.message;
            }
            
            input.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (err) {
                alert('ç™»å‡ºå¤±è´¥');
            }
        }

        // åˆå§‹åŒ–
        checkAuthStatus();
        fetchServers();
        fetchLogs();

        // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
        refreshInterval = setInterval(() => {
            fetchServers();
            fetchLogs();
        }, 5000);
    </script>
</body>
</html>
